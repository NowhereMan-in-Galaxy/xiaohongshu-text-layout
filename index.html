<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞èÁ∫¢‰π¶ÈïøÊñáÊéíÁâàÂ∑•ÂÖ∑</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .main-content {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .input-section {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .output-section {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background-color: #ff2442;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #e01f3d;
        }

        .secondary-btn {
            background-color: #666;
        }

        .secondary-btn:hover {
            background-color: #555;
        }

        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .page-preview {
            width: 300px;
            height: 533px;
            background: white;
            border: 1px solid #ddd;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .page-content {
            padding: 0;
            margin: 0;
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            word-wrap: break-word;
            word-break: break-all;
            overflow: hidden;
        }

        .page-content p {
            margin: 0;
            text-align: justify;
            word-break: break-all;
        }

        .page-number {
            position: absolute;
            bottom: 15px;
            right: 20px;
            color: #999;
            font-size: 12px;
        }

        .watermark {
            position: absolute;
            bottom: 15px;
            left: 20px;
            color: #ccc;
            font-size: 12px;
        }

        .settings {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .setting-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            min-width: 100px;
            font-size: 14px;
        }

        input[type="number"],
        input[type="text"] {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 200px;
        }

        .download-section {
            margin-top: 20px;
            text-align: center;
        }

        #canvas {
            display: none;
        }

        .tips {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            font-size: 13px;
            color: #856404;
        }

        .editor-toolbar {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 5px 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .toolbar-btn:hover {
            background: #5a6268;
        }

        .color-selector {
            display: flex;
            gap: 3px;
            margin-left: 10px;
        }

        .color-btn {
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
        }

        .markdown-preview {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }

        .page-header {
            padding: 15px 25px 0;
            font-weight: bold;
            color: #666;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .md-table {
            border-collapse: collapse;
            margin: 10px 0;
            width: 100%;
            font-size: 13px;
            background: #fff;
        }

        .md-table th,
        .md-table td {
            border: 1px solid #ddd;
            padding: 6px 10px;
            text-align: left;
        }

        .md-table th {
            background: #f5f5f5;
            font-weight: bold;
        }

        .md-table tr:nth-child(even) td {
            background: #fafafa;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>Â∞èÁ∫¢‰π¶ÈïøÊñáÊéíÁâàÂ∑•ÂÖ∑</h1>

        <div class="main-content">
            <div class="input-section">
                <h2>ËæìÂÖ•ÊñáÊú¨</h2>
                <div class="editor-toolbar">
                    <button class="toolbar-btn" onclick="insertHeading('#')" title="‰∏ÄÁ∫ßÊ†áÈ¢ò">H1</button>
                    <button class="toolbar-btn" onclick="insertHeading('##')" title="‰∫åÁ∫ßÊ†áÈ¢ò">H2</button>
                    <button class="toolbar-btn" onclick="insertHeading('###')" title="‰∏âÁ∫ßÊ†áÈ¢ò">H3</button>
                    <button class="toolbar-btn" onclick="insertMarkdown('**', '**')" title="Âä†Á≤ó">üí™ Âä†Á≤ó</button>
                    <button class="toolbar-btn" onclick="insertMarkdown('*', '*')" title="Êñú‰Ωì"><em>I</em> Êñú‰Ωì</button>
                    <button class="toolbar-btn" onclick="insertMarkdown('__', '__')" title="‰∏ãÂàíÁ∫ø"><u>U</u> ‰∏ãÂàíÁ∫ø</button>
                    <button class="toolbar-btn" onclick="insertMarkdown('~~', '~~')" title="Âà†Èô§Á∫ø"><s>S</s> Âà†Èô§Á∫ø</button>
                    <div class="color-selector">
                        <div class="color-btn" style="background: #ff4757;" onclick="insertColor('#ff4757')" title="Á∫¢Ëâ≤">
                        </div>
                        <div class="color-btn" style="background: #5352ed;" onclick="insertColor('#5352ed')" title="ËìùËâ≤">
                        </div>
                        <div class="color-btn" style="background: #2ed573;" onclick="insertColor('#2ed573')" title="ÁªøËâ≤">
                        </div>
                        <div class="color-btn" style="background: #ffa502;" onclick="insertColor('#ffa502')" title="Ê©ôËâ≤">
                        </div>
                        <div class="color-btn" style="background: #ff6348;" onclick="insertColor('#ff6348')"
                            title="ÁèäÁëöËâ≤"></div>
                        <div class="color-btn" style="background: #a55eea;" onclick="insertColor('#a55eea')" title="Á¥´Ëâ≤">
                        </div>
                    </div>
                </div>
                <textarea id="inputText" placeholder="ËØ∑ËæìÂÖ•ÊÇ®Ë¶ÅÊéíÁâàÁöÑÈïøÊñáÂÜÖÂÆπ..."></textarea>
                <div class="markdown-preview" id="markdownPreview" style="display:none;">
                    <strong>È¢ÑËßàÔºö</strong><br>
                    <div id="previewContent"></div>
                </div>

                <div class="settings">
                    <div class="setting-item">
                        <label>Â≠ó‰ΩìÂ§ßÂ∞èÔºö</label>
                        <input type="number" id="fontSize" value="13" min="12" max="20" title="ËÆæÁΩÆÂ≠ó‰ΩìÂ§ßÂ∞è"
                            aria-label="Â≠ó‰ΩìÂ§ßÂ∞è">
                        px
                    </div>
                    <div class="setting-item">
                        <label>Ë°åÈ´òÔºö</label>
                        <input type="number" id="lineHeight" value="1.8" min="1.2" max="2.5" step="0.1" title="ËÆæÁΩÆË°åÈ´ò"
                            aria-label="Ë°åÈ´ò">
                    </div>
                    <div class="setting-item">
                        <label>Ê∞¥Âç∞ÊñáÂ≠óÔºö</label>
                        <input type="text" id="watermarkText" placeholder="ËæìÂÖ•Ê∞¥Âç∞ÊñáÂ≠óÔºàÂèØÈÄâÔºâ" title="ËÆæÁΩÆÊ∞¥Âç∞ÊñáÂ≠ó" aria-label="Ê∞¥Âç∞ÊñáÂ≠ó">
                    </div>
                    <div class="setting-item">
                        <label>ËÉåÊôØÈ¢úËâ≤Ôºö</label>
                        <select id="bgColor" title="ÈÄâÊã©ËÉåÊôØÈ¢úËâ≤" aria-label="ËÉåÊôØÈ¢úËâ≤"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="white">Á∫ØÁôΩ</option>
                            <option value="cream">Á±≥Ëâ≤</option>
                            <option value="light-pink">Ê∑°Á≤âËâ≤</option>
                            <option value="light-blue">Ê∑°ËìùËâ≤</option>
                            <option value="light-green">Ê∑°ÁªøËâ≤</option>
                            <option value="light-yellow">Ê∑°ÈªÑËâ≤</option>
                            <option value="light-purple">Ê∑°Á¥´Ëâ≤</option>
                            <option value="light-gray">Ê∑°ÁÅ∞Ëâ≤</option>
                            <option value="gradient1">Ê∏êÂèòÁ≤â</option>
                            <option value="gradient2">Ê∏êÂèòËìù</option>
                            <option value="gradient3">Ê∏êÂèòÁ¥´</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Á∫πÁêÜÊïàÊûúÔºö</label>
                        <select id="bgTexture" title="ÈÄâÊã©ËÉåÊôØÁ∫πÁêÜ" aria-label="ËÉåÊôØÁ∫πÁêÜ"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="none">Êó†</option>
                            <option value="paper">Á∫∏Âº†Á∫πÁêÜ</option>
                            <option value="dots">ÁÇπÈòµ</option>
                            <option value="lines">Ê®™Á∫ø</option>
                            <option value="grid">ÁΩëÊ†º</option>
                            <option value="notebook">Á¨îËÆ∞Êú¨</option>
                            <option value="memo">‰æøÁ¨∫Á∫πÁêÜ</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>È£éÊ†ºÈ¢ÑËÆæÔºö</label>
                        <select id="stylePreset" onchange="applyPreset()" title="ÈÄâÊã©È£éÊ†ºÈ¢ÑËÆæ" aria-label="È£éÊ†ºÈ¢ÑËÆæ"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="custom">Ëá™ÂÆö‰πâ</option>
                            <option value="classic-memo">ÁªèÂÖ∏Â§áÂøòÂΩï</option>
                            <option value="modern-note">Áé∞‰ª£Á¨îËÆ∞</option>
                            <option value="vintage-paper">Â§çÂè§Á∫∏Âº†</option>
                            <option value="minimal-clean">ÁÆÄÁ∫¶Ê∏ÖÊñ∞</option>
                            <option value="warm-journal">Ê∏©ÊöñÊó•ËÆ∞</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>ÂõæÁâáÊØî‰æãÔºö</label>
                        <select id="aspectRatio" onchange="updatePreviewSize()" title="ÈÄâÊã©ÂõæÁâáÊØî‰æã" aria-label="ÂõæÁâáÊØî‰æã"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="2:3">2:3 Á´ñÁâà</option>
                            <option value="3:4">3:4 Â∞èÁ∫¢‰π¶Êé®Ëçê</option>
                            <option value="1:1">1:1 Ê≠£ÊñπÂΩ¢</option>
                            <option value="4:3">4:3 Ê®™Âêë</option>
                            <option value="16:9">16:9 ÂÆΩÂ±è</option>
                            <option value="9:16">9:16 Á´ñÂ±è</option>
                            <option value="custom">Ëá™ÂÆö‰πâÂ∞∫ÂØ∏</option>
                        </select>
                    </div>
                    <div class="setting-item" id="customSizeOptions" style="display:none;">
                        <label>Ëá™ÂÆö‰πâÂÆΩÂ∫¶Ôºö</label>
                        <input type="number" id="customWidth" value="900" min="300" max="2000"> px
                        <label style="margin-left: 15px;">È´òÂ∫¶Ôºö</label>
                        <input type="number" id="customHeight" value="1600" min="300" max="2000"> px
                    </div>
                    <div class="setting-item">
                        <label>Â≠ó‰ΩìÈÄâÊã©Ôºö</label>
                        <select id="fontFamily" title="ÈÄâÊã©Â≠ó‰Ωì" aria-label="Â≠ó‰ΩìÈÄâÊã©"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="default">Á≥ªÁªüÈªòËÆ§</option>
                            <option value="SimHei">Èªë‰Ωì</option>
                            <option value="SimSun">ÂÆã‰Ωì</option>
                            <option value="KaiTi">Ê•∑‰Ωì</option>
                            <option value="Microsoft YaHei">ÂæÆËΩØÈõÖÈªë</option>
                            <option value="PingFang SC">ËãπÊñπ</option>
                            <option value="Hiragino Sans GB">ÂÜ¨ÈùíÈªë‰Ωì</option>
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="custom">‰∏ä‰º†Ëá™ÂÆö‰πâÂ≠ó‰Ωì</option>
                        </select>
                    </div>
                    <div class="setting-item" id="customFontUpload" style="display:none;">
                        <label>Â≠ó‰ΩìÊñá‰ª∂Ôºö</label>
                        <input type="file" id="fontFile" accept=".ttf,.otf,.woff,.woff2"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                        <button type="button" onclick="loadCustomFont()" class="toolbar-btn"
                            style="margin-left: 10px;">Âä†ËΩΩÂ≠ó‰Ωì</button>
                    </div>
                    <div class="setting-item">
                        <label>Â≠ó‰Ωì‰∏ãËΩΩÔºö</label>
                        <button type="button" onclick="showFontDownloadInfo()" class="toolbar-btn">Ëé∑ÂèñÂ≠ó‰ΩìËµÑÊ∫ê</button>
                        <span style="font-size: 12px; color: #666; margin-left: 10px;">Ëé∑ÂèñÂÖçË¥π‰∏≠ÊñáÂ≠ó‰Ωì‰∏ãËΩΩÈìæÊé•</span>
                    </div>
                    <div class="setting-item">
                        <label>È°µÁúâËÆæÁΩÆÔºö</label>
                        <input type="checkbox" id="enableHeader" onchange="toggleHeaderOptions()" title="ÂêØÁî®Âõ∫ÂÆöÈ°µÁúâ"
                            aria-label="ÂêØÁî®Âõ∫ÂÆöÈ°µÁúâ">
                        <span>ÂêØÁî®Âõ∫ÂÆöÈ°µÁúâ</span>
                    </div>
                    <div class="setting-item" id="headerOptions" style="display:none;">
                        <label>È°µÁúâÊñáÂ≠óÔºö</label>
                        <input type="text" id="headerText" placeholder="ËæìÂÖ•È°µÁúâÊñáÂ≠ó"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                    </div>
                    <div class="setting-item" id="headerStyleOptions" style="display:none;">
                        <label>È°µÁúâÊ†∑ÂºèÔºö</label>
                        <select id="headerStyle"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="center">Â±Ö‰∏≠</option>
                            <option value="left">Â∑¶ÂØπÈΩê</option>
                            <option value="right">Âè≥ÂØπÈΩê</option>
                        </select>
                    </div>
                </div>

                <div class="controls">
                    <button onclick="generatePages()">ÁîüÊàêÊéíÁâà</button>
                    <button class="secondary-btn" onclick="togglePreview()">ÂàáÊç¢È¢ÑËßà</button>
                    <button class="secondary-btn" onclick="clearAll()">Ê∏ÖÁ©∫</button>
                </div>

                <div class="tips">
                    <strong>‰ΩøÁî®ÊèêÁ§∫Ôºö</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>ËæìÂÖ•ÊñáÊú¨ÂêéÁÇπÂáª"ÁîüÊàêÊéíÁâà"</li>
                        <li>Êô∫ËÉΩÂàÜÈ°µÔºöÁ≥ªÁªüËá™Âä®ÂàÜÈ°µÔºåÁ°Æ‰øùÂÜÖÂÆπ‰∏çË¶ÜÁõñÊ∞¥Âç∞ÂíåÈ°µÁ†Å</li>
                        <li>ÂõûËΩ¶ÊéßÂà∂Ôºö‰ΩøÁî®ÂõûËΩ¶ÊéßÂà∂ÊÆµËêΩÈó¥Ë∑ùÂíåÁ©∫ÁôΩÔºåÂ§ö‰∏™ÂõûËΩ¶ÂàõÂª∫Êõ¥Â§öÁ©∫ÁôΩ</li>
                        <li>ÂÜÖÂÆπ‰øùÊä§ÔºöÈ°µÈù¢ÂÆπÈáèÊô∫ËÉΩËÆ°ÁÆóÔºåÈÅøÂÖçÂÜÖÂÆπË∂ÖÂá∫ËåÉÂõ¥</li>
                        <li>ÊîØÊåÅMarkdownÊ†ºÂºèÔºö# ‰∏ÄÁ∫ßÊ†áÈ¢ò ## ‰∫åÁ∫ßÊ†áÈ¢ò ### ‰∏âÁ∫ßÊ†áÈ¢ò **Âä†Á≤ó** *Êñú‰Ωì* __‰∏ãÂàíÁ∫ø__ [color:#ff0000]Á∫¢Ëâ≤[/color]</li>
                        <li>ÂèØ‰ΩøÁî®Â∑•ÂÖ∑Ê†èÂø´ÈÄüÊ∑ªÂä†Ê†ºÂºèÔºåÊàñÊâãÂä®ÁºñÂÜôMarkdown</li>
                        <li>Ê†áÈ¢òÂäüËÉΩÔºöÁÇπÂáªH1/H2/H3ÊåâÈíÆÂø´ÈÄüÊ∑ªÂä†Ê†áÈ¢òÔºåÊàñÊâãÂä®ËæìÂÖ•#„ÄÅ##„ÄÅ###</li>
                        <li>ÁÇπÂáª"ÂàáÊç¢È¢ÑËßà"Êü•ÁúãÊ†ºÂºèÊïàÊûú</li>
                        <li>ÁÇπÂáª"‰∏ãËΩΩÂΩìÂâçÈ°µ"ÂèØ‰øùÂ≠òÂçïÂº†ÂõæÁâá</li>
                        <li>ÁÇπÂáª"‰∏ãËΩΩÊâÄÊúâÈ°µ"ÂèØÊâπÈáè‰øùÂ≠ò</li>
                    </ul>
                </div>
            </div>

            <div class="output-section">
                <h2>È¢ÑËßàÊïàÊûú</h2>
                <div id="previewContainer" class="preview-container"></div>
                <div class="download-section" id="downloadSection" style="display: none;">
                    <button onclick="downloadCurrentPage()">‰∏ãËΩΩÂΩìÂâçÈ°µ</button>
                    <button onclick="downloadAllPages()">‰∏ãËΩΩÊâÄÊúâÈ°µ</button>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // ÂÖ®Â±ÄÂèòÈáèÂ£∞Êòé
        let currentPages = [];
        let currentPageIndex = 0;

        // ÊÅ¢Â§çÊúÄÂàùÁöÑÂàÜÈ°µÂáΩÊï∞ÔºöÊÆµËêΩÊï¥‰ΩìÂàÜÈ°µÔºå‰∏çÂàÜË°åÂ°´Êª°
        function splitTextIntoPages(text) {
            try {
                const fontSize = parseInt(document.getElementById('fontSize').value) || 13;
                const lineHeight = parseFloat(document.getElementById('lineHeight').value) || 1.8;
                const enableHeader = document.getElementById('enableHeader').checked || false;
                const aspectRatio = document.getElementById('aspectRatio').value || '2:3';
                const dimensions = getAspectRatioDimensions(aspectRatio);

                const pageHeight = dimensions.preview.height;
                const pageWidth = dimensions.preview.width;

                const padding = {
                    top: 15,
                    bottom: 20,
                    left: 20,
                    right: 20
                };
                const headerHeight = enableHeader ? 30 : 0;
                const footerHeight = 30;
                const availableHeight = pageHeight - padding.top - padding.bottom - headerHeight - footerHeight;
                const availableWidth = pageWidth - padding.left - padding.right;
                const lineHeightPx = fontSize * lineHeight;
                const maxLinesPerPage = Math.max(1, Math.floor(availableHeight / lineHeightPx) - 1);
                const charsPerLine = Math.floor(availableWidth / (fontSize * 0.9));

                const paragraphs = text.split('\n');
                // Â§ÑÁêÜÊØè‰∏™ÊÆµËêΩÔºåËÆ°ÁÆóÂÆûÈôÖÂç†Áî®ÁöÑË°åÊï∞
                const processedParagraphs = paragraphs.map(paragraph => {
                    if (paragraph.trim() === '') {
                        // Á©∫Ë°åÂç†‰∏ÄË°å
                        return {
                            text: '',
                            lines: 1,
                            isEmptyLine: true
                        };
                    }
                    // ÁßªÈô§MarkdownÊ†áËÆ∞Êù•ËÆ°ÁÆóÂÆûÈôÖÈïøÂ∫¶
                    const plainText = paragraph
                        .replace(/\*\*(.*?)\*\*/g, '$1')
                        .replace(/\*(.*?)\*/g, '$1')
                        .replace(/__(.*?)__/g, '$1')
                        .replace(/~~(.*?)~~/g, '$1')
                        .replace(/\[color:#[a-fA-F0-9]{6}\](.*?)\[\/color\]/g, '$1');
                    // ËÆ°ÁÆóËøô‰∏™ÊÆµËêΩÈúÄË¶ÅÂ§öÂ∞ëË°å
                    const linesNeeded = Math.ceil(plainText.length / charsPerLine) || 1;
                    return {
                        text: paragraph,
                        lines: linesNeeded,
                        isEmptyLine: false
                    };
                });
                // ÂàÜÈ°µ
                const pages = [];
                let currentPage = [];
                let currentPageLines = 0;
                for (let i = 0; i < processedParagraphs.length; i++) {
                    const paragraph = processedParagraphs[i];
                    // Ê£ÄÊü•ÂΩìÂâçÊÆµËêΩÊòØÂê¶ËÉΩÊîæÂÖ•ÂΩìÂâçÈ°µ
                    if (currentPageLines + paragraph.lines > maxLinesPerPage && currentPage.length > 0) {
                        // ÂΩìÂâçÈ°µÂ∑≤Êª°ÔºåÂàõÂª∫Êñ∞È°µ
                        pages.push(currentPage.map(p => p.text));
                        currentPage = [paragraph];
                        currentPageLines = paragraph.lines;
                    } else {
                        // Ê∑ªÂä†Âà∞ÂΩìÂâçÈ°µ
                        currentPage.push(paragraph);
                        currentPageLines += paragraph.lines;
                    }
                }
                // Ê∑ªÂä†ÊúÄÂêé‰∏ÄÈ°µ
                if (currentPage.length > 0) {
                    pages.push(currentPage.map(p => p.text));
                }
                if (pages.length === 0) {
                    pages.push(['']);
                }
                return pages;
            } catch (error) {
                console.error('ÂàÜÈ°µÈîôËØØ:', error);
                return [['']];
            }
        }

        function parseMarkdown(text) {
            // 1. ÂÖàÊï¥‰ΩìËØÜÂà´ÊâÄÊúâË°®Ê†ºÂùóÔºåÊõøÊç¢‰∏∫ÂîØ‰∏ÄÂç†‰ΩçÁ¨¶
            let tableMap = {};
            let tableIdx = 0;
            text = text.replace(/((?:^\s*\|.*\|.*(?:\n|$))+)/gm, function (tableBlock) {
                const lines = tableBlock.trim().split('\n');
                if (lines.length < 2) return tableBlock;
                if (!/^\s*\|?\s*(:?-+:?\s*\|)+\s*$/.test(lines[1])) return tableBlock;
                const key = `__TABLE_BLOCK_${tableIdx}__`;
                tableMap[key] = tableBlock;
                tableIdx++;
                return key;
            });
            // 2. ÂÖ∂ÂÆÉMarkdownÂ§ÑÁêÜ
            text = text
                // Â§ÑÁêÜÊ†áÈ¢ò (ÂøÖÈ°ªÂú®ÂÖ∂‰ªñÊ†ºÂºè‰πãÂâçÂ§ÑÁêÜ)
                .replace(/^### (.*$)/gim, '<h3 style="margin: 0; margin-bottom: 0.3em; font-size: 0.9em; font-weight: bold; color: #333;">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 style="margin: 0; margin-bottom: 0.3em; font-size: 1.1em; font-weight: bold; color: #333;">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 style="margin: 0; margin-bottom: 0.3em; font-size: 1.2em; font-weight: bold; color: #333;">$1</h1>')
                // Â§ÑÁêÜÂÖ∂‰ªñÊ†ºÂºè
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/__(.*?)__/g, '<u>$1</u>')
                .replace(/~~(.*?)~~/g, '<del>$1</del>')
                .replace(/\[color:(#[a-fA-F0-9]{6})\](.*?)\[\/color\]/g, '<span style="color:$1">$2</span>');
            // 3. ÊõøÊç¢ÂõûË°®Ê†ºHTML
            Object.keys(tableMap).forEach(key => {
                text = text.replace(key, renderMarkdownTable(tableMap[key].split('\n')));
            });
            return text;
        }

        // Ê∏≤ÊüìMarkdownË°®Ê†º‰∏∫HTML
        function renderMarkdownTable(lines) {
            if (lines.length < 2) return lines.join('<br>');
            const headerCells = lines[0].split('|').slice(1, -1).map(cell => cell.trim());
            const rows = lines.slice(2).map(row => row.split('|').slice(1, -1).map(cell => cell.trim()));
            let html = '<table class="md-table"><thead><tr>';
            headerCells.forEach(cell => { html += `<th>${parseMarkdown(cell)}</th>`; });
            html += '</tr></thead><tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => { html += `<td>${parseMarkdown(cell)}</td>`; });
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        // ÊîπËøõÁöÑÊ†ºÂºèÂåñÊñáÊú¨ÂáΩÊï∞
        function formatTextWithParagraphs(lines) {
            return lines.map((line, index) => {
                if (line.trim() === '') {
                    // Á©∫Ë°å‰øùÊåÅÂõ∫ÂÆöÈ´òÂ∫¶Ôºå‰ΩÜÂáèÂ∞ëÈ´òÂ∫¶
                    return '<p style="margin: 0; height: 0.5em;">&nbsp;</p>';
                } else {
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊ†áÈ¢ò
                    const isHeading = /^#{1,3}\s/.test(line);

                    if (isHeading) {
                        // Ê†áÈ¢ò‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÁöÑÂåÖË£Ö
                        return parseMarkdown(line);
                    } else {
                        // Ê≠£Â∏∏ÊÆµËêΩÔºåÂáèÂ∞ëÊÆµËêΩÈó¥Ë∑ù
                        const marginBottom = index === lines.length - 1 ? '0' : '0.3em';
                        return `<p style="margin: 0; margin-bottom: ${marginBottom}; text-align: justify; word-break: break-all;">${parseMarkdown(line)}</p>`;
                    }
                }
            }).join('');
        }

        function getBackgroundColor(colorOption) {
            switch (colorOption) {
                case 'cream': return '#FFF8E7';
                case 'light-pink': return '#FDF2F8';
                case 'light-blue': return '#EFF6FF';
                case 'light-green': return '#F0FDF4';
                case 'light-yellow': return '#FEFCE8';
                case 'light-purple': return '#FAF5FF';
                case 'light-gray': return '#F9FAFB';
                case 'gradient1': return 'linear-gradient(135deg, #FFE0EC 0%, #FFF5E0 100%)';
                case 'gradient2': return 'linear-gradient(135deg, #E0F0FF 0%, #F0E0FF 100%)';
                case 'gradient3': return 'linear-gradient(135deg, #F5E0FF 0%, #E0E8FF 100%)';
                default: return 'white';
            }
        }

        function getTextureOverlay(textureOption) {
            switch (textureOption) {
                case 'paper':
                    return 'repeating-linear-gradient(123deg, transparent, transparent 2px, rgba(0,0,0,0.008) 2px, rgba(0,0,0,0.008) 3px), repeating-linear-gradient(27deg, transparent, transparent 1px, rgba(0,0,0,0.005) 1px, rgba(0,0,0,0.005) 2px), radial-gradient(circle at 20% 50%, rgba(0,0,0,0.01) 0%, transparent 50%), radial-gradient(circle at 80% 30%, rgba(0,0,0,0.01) 0%, transparent 50%)';
                case 'dots':
                    return 'radial-gradient(circle at 10px 10px, rgba(0,0,0,0.1) 1px, transparent 0), radial-gradient(circle at 10px 10px, rgba(0,0,0,0.1) 1px, transparent 0)';
                case 'lines':
                    return 'repeating-linear-gradient(0deg, transparent, transparent 23px, rgba(0,0,0,0.1) 24px)';
                case 'grid':
                    return 'repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(0,0,0,0.05) 20px), repeating-linear-gradient(90deg, transparent, transparent 19px, rgba(0,0,0,0.05) 20px)';
                case 'notebook':
                    return 'repeating-linear-gradient(0deg, transparent, transparent 23px, rgba(0,0,0,0.1) 24px), linear-gradient(90deg, #ff69b4 80px, #ff69b4 82px, transparent 82px)';
                case 'memo':
                    return 'linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%), linear-gradient(-45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%)';
                default:
                    return null;
            }
        }

        function applyBackground(element, bgColor, bgTexture) {
            const baseColor = getBackgroundColor(bgColor);
            element.style.background = baseColor;

            if (bgTexture !== 'none') {
                const textureOverlay = getTextureOverlay(bgTexture);
                if (textureOverlay) {
                    element.style.background = textureOverlay + ', ' + baseColor;
                    if (bgTexture === 'dots') {
                        element.style.backgroundSize = '20px 20px, 20px 20px';
                    } else if (bgTexture === 'memo') {
                        element.style.backgroundSize = '10px 10px, 10px 10px';
                    }
                }
            }
        }

        function applyPreset() {
            const preset = document.getElementById('stylePreset').value;
            const bgColorSelect = document.getElementById('bgColor');
            const bgTextureSelect = document.getElementById('bgTexture');

            switch (preset) {
                case 'classic-memo':
                    bgColorSelect.value = 'light-yellow';
                    bgTextureSelect.value = 'lines';
                    break;
                case 'modern-note':
                    bgColorSelect.value = 'white';
                    bgTextureSelect.value = 'dots';
                    break;
                case 'vintage-paper':
                    bgColorSelect.value = 'cream';
                    bgTextureSelect.value = 'paper';
                    break;
                case 'minimal-clean':
                    bgColorSelect.value = 'white';
                    bgTextureSelect.value = 'none';
                    break;
                case 'warm-journal':
                    bgColorSelect.value = 'light-pink';
                    bgTextureSelect.value = 'memo';
                    break;
            }
        }

        function getAspectRatioDimensions(ratio) {
            const previewBase = 300;
            const downloadBase = 900;

            switch (ratio) {
                case '1:1':
                    return {
                        preview: { width: previewBase, height: previewBase },
                        download: { width: downloadBase, height: downloadBase }
                    };
                case '3:4':
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 4 / 3) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 4 / 3) }
                    };
                case '4:3':
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 3 / 4) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 3 / 4) }
                    };
                case '16:9':
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 9 / 16) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 9 / 16) }
                    };
                case '9:16':
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 16 / 9) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 16 / 9) }
                    };
                case '2:3':
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 3 / 2) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 3 / 2) }
                    };
                case 'custom':
                    const customWidth = parseInt(document.getElementById('customWidth').value) || 900;
                    const customHeight = parseInt(document.getElementById('customHeight').value) || 1600;
                    const scale = previewBase / customWidth;
                    return {
                        preview: { width: previewBase, height: Math.round(customHeight * scale) },
                        download: { width: customWidth, height: customHeight }
                    };
                default:
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 3 / 2) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 3 / 2) }
                    };
            }
        }

        function updatePreviewSize() {
            const aspectRatio = document.getElementById('aspectRatio').value;
            const customOptions = document.getElementById('customSizeOptions');

            customOptions.style.display = aspectRatio === 'custom' ? 'block' : 'none';

            const pagePreviewElements = document.querySelectorAll('.page-preview');
            const dimensions = getAspectRatioDimensions(aspectRatio);

            pagePreviewElements.forEach(element => {
                element.style.width = dimensions.preview.width + 'px';
                element.style.height = dimensions.preview.height + 'px';
            });

            const inputText = document.getElementById('inputText').value;
            if (inputText.trim() && currentPages.length > 0) {
                generatePages();
            }
        }

        function updateFontDisplay() {
            const fontFamily = document.getElementById('fontFamily').value;
            const customFontUpload = document.getElementById('customFontUpload');

            customFontUpload.style.display = fontFamily === 'custom' ? 'block' : 'none';

            const pageContentElements = document.querySelectorAll('.page-content');
            pageContentElements.forEach(element => {
                if (fontFamily === 'default') {
                    element.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif';
                } else if (fontFamily !== 'custom') {
                    element.style.fontFamily = `"${fontFamily}", -apple-system, BlinkMacSystemFont, sans-serif`;
                }
            });
        }

        function regenerateIfNeeded() {
            const inputText = document.getElementById('inputText').value;
            if (inputText.trim() && currentPages.length > 0) {
                generatePages();
            }
        }

        function loadCustomFont() {
            const fileInput = document.getElementById('fontFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('ËØ∑ÈÄâÊã©Â≠ó‰ΩìÊñá‰ª∂');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const fontData = e.target.result;
                const fontFamily = 'CustomFont_' + Date.now();

                const style = document.createElement('style');
                style.textContent = `
                    @font-face {
                        font-family: "${fontFamily}";
                        src: url(${fontData});
                    }
                `;
                document.head.appendChild(style);

                const pageContentElements = document.querySelectorAll('.page-content');
                pageContentElements.forEach(element => {
                    element.style.fontFamily = `"${fontFamily}", sans-serif`;
                });

                alert('Â≠ó‰ΩìÂä†ËΩΩÊàêÂäüÔºÅ');
            };

            reader.readAsDataURL(file);
        }

        function showFontDownloadInfo() {
            const fontInfo = `
                <div style="max-width: 500px; text-align: left;">
                    <h3>ÂÖçË¥π‰∏≠ÊñáÂ≠ó‰ΩìËµÑÊ∫êÊé®ËçêÔºö</h3>
                    <br>
                    <strong>1. ÊÄùÊ∫êÂ≠ó‰ΩìÁ≥ªÂàóÔºö</strong><br>
                    ‚Ä¢ ÊÄùÊ∫êÈªë‰Ωì (Source Han Sans)<br>
                    ‚Ä¢ ÊÄùÊ∫êÂÆã‰Ωì (Source Han Serif)<br>
                    ‚Ä¢ ‰∏ãËΩΩÂú∞ÂùÄÔºöGitHub ÊêúÁ¥¢ "adobe-fonts"<br>
                    <br>
                    <strong>2. Á´ôÈÖ∑Â≠ó‰ΩìÁ≥ªÂàóÔºö</strong><br>
                    ‚Ä¢ Á´ôÈÖ∑È´òÁ´ØÈªë„ÄÅÁ´ôÈÖ∑Âø´‰πê‰Ωì„ÄÅÁ´ôÈÖ∑ÊñáËâ∫‰Ωì<br>
                    ‚Ä¢ ‰∏ãËΩΩÂú∞ÂùÄÔºöÁ´ôÈÖ∑ÁΩë (zcool.com.cn)<br>
                    <br>
                    <strong>3. ÊñπÊ≠£Â≠óÂ∫ìÂÖçË¥πÂ≠ó‰ΩìÔºö</strong><br>
                    ‚Ä¢ ÊñπÊ≠£Èªë‰Ωì„ÄÅÊñπÊ≠£Ê•∑‰Ωì„ÄÅÊñπÊ≠£‰ªøÂÆã<br>
                    ‚Ä¢ ‰∏ãËΩΩÂú∞ÂùÄÔºöÊñπÊ≠£Â≠óÂ∫ìÂÆòÁΩë<br>
                    <br>
                    <strong>4. ÊñáÊ≥âÈ©øÂ≠ó‰ΩìÔºö</strong><br>
                    ‚Ä¢ ÊñáÊ≥âÈ©øÂæÆÁ±≥Èªë„ÄÅÊñáÊ≥âÈ©øÊ≠£Èªë<br>
                    ‚Ä¢ ‰∏ãËΩΩÂú∞ÂùÄÔºöwenq.org<br>
                    <br>
                    <strong>‰ΩøÁî®ËØ¥ÊòéÔºö</strong><br>
                    1. ‰∏ãËΩΩÂ≠ó‰ΩìÊñá‰ª∂(.ttf, .otfÊ†ºÂºè)<br>
                    2. Âú®"Â≠ó‰ΩìÈÄâÊã©"‰∏≠ÈÄâÊã©"‰∏ä‰º†Ëá™ÂÆö‰πâÂ≠ó‰Ωì"<br>
                    3. ÁÇπÂáª"ÈÄâÊã©Êñá‰ª∂"‰∏ä‰º†Â≠ó‰Ωì<br>
                    4. ÁÇπÂáª"Âä†ËΩΩÂ≠ó‰Ωì"Âç≥ÂèØ‰ΩøÁî®<br>
                </div>
            `;

            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            `;

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'ÂÖ≥Èó≠';
            closeBtn.style.cssText = `
                position: absolute;
                top: 10px;
                right: 15px;
                background: #ff2442;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
            `;
            closeBtn.onclick = () => document.body.removeChild(popup);

            content.innerHTML = fontInfo;
            content.appendChild(closeBtn);
            popup.appendChild(content);
            document.body.appendChild(popup);
        }

        function toggleHeaderOptions() {
            const enableHeader = document.getElementById('enableHeader').checked;
            const headerOptions = document.getElementById('headerOptions');
            const headerStyleOptions = document.getElementById('headerStyleOptions');

            headerOptions.style.display = enableHeader ? 'block' : 'none';
            headerStyleOptions.style.display = enableHeader ? 'block' : 'none';
        }

        // ÊîπËøõÁöÑÁîüÊàêÈ°µÈù¢ÂáΩÊï∞
        function generatePages() {
            try {
                const inputText = document.getElementById('inputText').value;

                if (!inputText || !inputText.trim()) {
                    alert('ËØ∑ËæìÂÖ•Ë¶ÅÊéíÁâàÁöÑÊñáÊú¨');
                    return;
                }

                const fontSize = document.getElementById('fontSize').value;
                const lineHeight = document.getElementById('lineHeight').value;
                const watermarkText = document.getElementById('watermarkText').value;
                const bgColor = document.getElementById('bgColor').value;
                const bgTexture = document.getElementById('bgTexture').value;
                const fontFamily = document.getElementById('fontFamily').value;
                const enableHeader = document.getElementById('enableHeader').checked;
                const headerText = document.getElementById('headerText').value;
                const headerStyle = document.getElementById('headerStyle').value;

                currentPages = splitTextIntoPages(inputText);

                const previewContainer = document.getElementById('previewContainer');
                previewContainer.innerHTML = '';

                const aspectRatio = document.getElementById('aspectRatio').value;
                const dimensions = getAspectRatioDimensions(aspectRatio);

                currentPages.forEach((pageTextArray, index) => {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'page-preview';
                    pageDiv.setAttribute('data-page-index', index);
                    pageDiv.style.width = dimensions.preview.width + 'px';
                    pageDiv.style.height = dimensions.preview.height + 'px';
                    pageDiv.style.position = 'relative';
                    pageDiv.style.overflow = 'hidden';
                    applyBackground(pageDiv, bgColor, bgTexture);

                    // ÂàõÂª∫ÂÜÖÂÆπÂÆπÂô®
                    const contentWrapper = document.createElement('div');
                    contentWrapper.style.cssText = `
                        position: absolute;
                        top: ${enableHeader && headerText.trim() ? '70px' : '30px'};
                        left: 25px;
                        right: 25px;
                        bottom: 55px;
                        overflow: hidden;
                    `;

                    // Ê∑ªÂä†È°µÁúâ
                    if (enableHeader && headerText.trim()) {
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'page-header';
                        headerDiv.style.cssText = `
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            padding: 15px 25px;
                            font-size: ${Math.max(parseInt(fontSize) - 2, 12)}px;
                            font-weight: bold;
                            color: #666;
                            text-align: ${headerStyle};
                            border-bottom: 1px solid #eee;
                            background: rgba(255, 255, 255, 0.5);
                        `;

                        if (fontFamily === 'default') {
                            headerDiv.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif';
                        } else if (fontFamily !== 'custom') {
                            headerDiv.style.fontFamily = `"${fontFamily}", -apple-system, BlinkMacSystemFont, sans-serif`;
                        }

                        headerDiv.textContent = headerText;
                        pageDiv.appendChild(headerDiv);
                    }

                    // Ê∑ªÂä†ÂÜÖÂÆπ
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'page-content';
                    contentDiv.style.cssText = `
                        font-size: ${fontSize}px;
                        line-height: ${lineHeight};
                        color: #333;
                        word-wrap: break-word;
                        word-break: break-all;
                    `;

                    if (fontFamily === 'default') {
                        contentDiv.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif';
                    } else if (fontFamily !== 'custom') {
                        contentDiv.style.fontFamily = `"${fontFamily}", -apple-system, BlinkMacSystemFont, sans-serif`;
                    }

                    contentDiv.innerHTML = formatTextWithParagraphs(pageTextArray);
                    contentWrapper.appendChild(contentDiv);
                    pageDiv.appendChild(contentWrapper);

                    // Ê∑ªÂä†È°µÁ†Å
                    const pageNumber = document.createElement('div');
                    pageNumber.className = 'page-number';
                    pageNumber.style.cssText = `
                        position: absolute;
                        bottom: 15px;
                        right: 20px;
                        color: #999;
                        font-size: 12px;
                    `;
                    pageNumber.textContent = `${index + 1}/${currentPages.length}`;
                    pageDiv.appendChild(pageNumber);

                    // Ê∑ªÂä†Ê∞¥Âç∞
                    if (watermarkText) {
                        const watermark = document.createElement('div');
                        watermark.className = 'watermark';
                        watermark.style.cssText = `
                            position: absolute;
                            bottom: 15px;
                            left: 20px;
                            color: #ccc;
                            font-size: 12px;
                        `;
                        watermark.textContent = watermarkText;
                        pageDiv.appendChild(watermark);
                    }

                    // ÁÇπÂáªÈÄâ‰∏≠ÊïàÊûú
                    pageDiv.onclick = () => {
                        currentPageIndex = index;
                        document.querySelectorAll('.page-preview').forEach(p => p.style.border = '1px solid #ddd');
                        pageDiv.style.border = '2px solid #ff2442';
                    };

                    previewContainer.appendChild(pageDiv);
                });

                if (currentPages.length > 0) {
                    document.getElementById('downloadSection').style.display = 'block';
                }
            } catch (error) {
                console.error('ÁîüÊàêÈ°µÈù¢ÈîôËØØ:', error);
                alert('ÁîüÊàêÈ°µÈù¢Êó∂Âá∫Áé∞ÈîôËØØÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑËæìÂÖ•');
            }
        }

        // html2canvas‰∏ãËΩΩÂáΩÊï∞
        function downloadPageByHtml2Canvas(pageIndex) {
            const pageElement = document.querySelector(`[data-page-index="${pageIndex}"]`);
            if (!pageElement) return;
            html2canvas(pageElement, {
                scale: 4, // ÊèêÈ´òÂØºÂá∫Ê∏ÖÊô∞Â∫¶
                useCORS: true
            }).then(canvas => {
                const url = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = url;
                a.download = `Â∞èÁ∫¢‰π¶ÊéíÁâà_Á¨¨${pageIndex + 1}È°µ.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        }

        function downloadCurrentPage() {
            downloadPageByHtml2Canvas(currentPageIndex);
        }

        function downloadAllPages() {
            if (confirm(`Á°ÆÂÆöË¶Å‰∏ãËΩΩÂÖ®ÈÉ® ${currentPages.length} È°µÂêóÔºü`)) {
                let delay = 0;
                currentPages.forEach((_, index) => {
                    setTimeout(() => downloadPageByHtml2Canvas(index), delay);
                    delay += 800;
                });
            }
        }

        function clearAll() {
            document.getElementById('inputText').value = '';
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('downloadSection').style.display = 'none';
            currentPages = [];
            currentPageIndex = 0;
        }

        function insertHeading(level) {
            const textarea = document.getElementById('inputText');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            // Ëé∑ÂèñÂΩìÂâçË°åÁöÑÂÜÖÂÆπ
            const lines = textarea.value.split('\n');
            let currentLineIndex = 0;
            let currentPos = 0;

            for (let i = 0; i < lines.length; i++) {
                if (currentPos <= start && start <= currentPos + lines[i].length) {
                    currentLineIndex = i;
                    break;
                }
                currentPos += lines[i].length + 1; // +1 for newline
            }

            if (selectedText) {
                // Â¶ÇÊûúÊúâÈÄâ‰∏≠ÁöÑÊñáÊú¨ÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫Ê†áÈ¢ò
                const replacement = level + ' ' + selectedText;
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.selectionStart = start;
                textarea.selectionEnd = start + replacement.length;
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠ÊñáÊú¨ÔºåÂú®ÂΩìÂâçË°åÂºÄÂ§¥ÊèíÂÖ•Ê†áÈ¢òÊ†ºÂºè
                const currentLine = lines[currentLineIndex];
                const lineStart = currentPos;
                const lineEnd = lineStart + currentLine.length;

                // Ê£ÄÊü•ÂΩìÂâçË°åÊòØÂê¶Â∑≤ÁªèÊòØÊ†áÈ¢ò
                if (currentLine.match(/^#{1,3}\s/)) {
                    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊ†áÈ¢òÔºåÊõøÊç¢Ê†áÈ¢òÁ∫ßÂà´
                    const newLine = level + ' ' + currentLine.replace(/^#{1,3}\s/, '');
                    textarea.value = textarea.value.substring(0, lineStart) + newLine + textarea.value.substring(lineEnd);
                    textarea.selectionStart = lineStart;
                    textarea.selectionEnd = lineStart + newLine.length;
                } else {
                    // Â¶ÇÊûú‰∏çÊòØÊ†áÈ¢òÔºåÂú®Ë°åÈ¶ñÊ∑ªÂä†Ê†áÈ¢òÊ†ºÂºè
                    const newLine = level + ' ' + currentLine;
                    textarea.value = textarea.value.substring(0, lineStart) + newLine + textarea.value.substring(lineEnd);
                    textarea.selectionStart = lineStart + level.length + 1;
                    textarea.selectionEnd = lineStart + level.length + 1;
                }
            }
            textarea.focus();
            updatePreview();
        }

        function insertMarkdown(startTag, endTag) {
            const textarea = document.getElementById('inputText');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            if (selectedText) {
                const replacement = startTag + selectedText + endTag;
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.selectionStart = start;
                textarea.selectionEnd = start + replacement.length;
            } else {
                const replacement = startTag + 'ËØ∑ËæìÂÖ•ÊñáÂ≠ó' + endTag;
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.selectionStart = start + startTag.length;
                textarea.selectionEnd = start + startTag.length + 4;
            }
            textarea.focus();
            updatePreview();
        }

        function insertColor(color) {
            const textarea = document.getElementById('inputText');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            const startTag = `[color:${color}]`;
            const endTag = '[/color]';

            if (selectedText) {
                const replacement = startTag + selectedText + endTag;
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.selectionStart = start;
                textarea.selectionEnd = start + replacement.length;
            } else {
                const replacement = startTag + 'ËØ∑ËæìÂÖ•ÊñáÂ≠ó' + endTag;
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.selectionStart = start + startTag.length;
                textarea.selectionEnd = start + startTag.length + 4;
            }
            textarea.focus();
            updatePreview();
        }

        function togglePreview() {
            const preview = document.getElementById('markdownPreview');
            if (preview.style.display === 'none') {
                preview.style.display = 'block';
                updatePreview();
            } else {
                preview.style.display = 'none';
            }
        }

        function updatePreview() {
            const inputText = document.getElementById('inputText').value;
            const previewContent = document.getElementById('previewContent');
            const preview = document.getElementById('markdownPreview');

            if (preview.style.display !== 'none') {
                previewContent.innerHTML = parseMarkdown(inputText.replace(/\n/g, '<br>'));
            }
        }

        // DOMContentLoaded ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.addEventListener('DOMContentLoaded', function () {
            // ËÆæÁΩÆÁ§∫‰æãÊñáÊú¨
            const inputText = document.getElementById('inputText');
            if (inputText) {
                inputText.value = `# Â∞èÁ∫¢‰π¶ÈïøÊñáÊéíÁâàÂ∑•ÂÖ∑‰ΩøÁî®ÊåáÂçó

ËøôÊòØ‰∏Ä‰∏™**Á§∫‰æãÊñáÊú¨**„ÄÇÂ∞èÁ∫¢‰π¶ÊòØ‰∏Ä‰∏™ÁîüÊ¥ªÊñπÂºèÂàÜ‰∫´Âπ≥Âè∞ÔºåÁî®Êà∑ÂèØ‰ª•ÈÄöËøáÂõæÁâá„ÄÅËßÜÈ¢ëÂíåÊñáÂ≠óËÆ∞ÂΩïÁîüÊ¥ªÁÇπÊª¥ÔºåÂèëÁé∞ÁæéÂ•Ω‰∫ãÁâ©„ÄÇ

## Âπ≥Âè∞ÁâπËâ≤

Âú®Ëøô‰∏™Âπ≥Âè∞‰∏äÔºå‰Ω†ÂèØ‰ª•ÊâæÂà∞ÂêÑÁßç*ÁîüÊ¥ªÁÅµÊÑü*„ÄÇ‰ªé[color:#ff4757]ÁæéÈ£üÂà∂‰Ωú[/color]Âà∞ÊóÖË°åÊîªÁï•Ôºå‰ªéÊä§ËÇ§ÂøÉÂæóÂà∞Á©øÊê≠ÊäÄÂ∑ßÔºåÊØè‰∏™‰∫∫ÈÉΩËÉΩÂú®ËøôÈáåÊâæÂà∞Ëá™Â∑±ÊÑüÂÖ¥Ë∂£ÁöÑÂÜÖÂÆπ„ÄÇ

### Âàõ‰ΩúËÄÖÂàÜ‰∫´

Âàõ‰ΩúËÄÖ‰ª¨Áî®ÂøÉÂàÜ‰∫´ÁùÄËá™Â∑±ÁöÑÁªèÈ™åÂíåËßÅËß£„ÄÇ‰ªñ‰ª¨ÈÄöËøá__Á≤æÁæéÁöÑÂõæÁâá__ÂíåËØ¶ÁªÜÁöÑÊñáÂ≠óÔºåÂ∏ÆÂä©ÂÖ∂‰ªñÁî®Êà∑Ëß£ÂÜ≥ÁîüÊ¥ª‰∏≠ÁöÑÂêÑÁßçÈóÆÈ¢ò„ÄÇ

ËøôÁßçÂàÜ‰∫´Á≤æÁ•ûËÆ©Â∞èÁ∫¢‰π¶Êàê‰∏∫‰∫Ü‰∏Ä‰∏™ÂÖÖÊª°Ê≠£ËÉΩÈáèÁöÑÁ§æÂå∫„ÄÇ

## ÈïøÊñáÊéíÁâàÊåëÊàò

ÂØπ‰∫éÈïøÊñáÂàõ‰ΩúËÄÖÊù•ËØ¥ÔºåÂ¶Ç‰ΩïÂ∞ÜÂ§ßÊÆµÊñáÂ≠ó‰ºòÈõÖÂú∞ÂëàÁé∞Âú®Â∞èÁ∫¢‰π¶‰∏äÊòØ‰∏Ä‰∏™~~ÊåëÊàò~~**Êú∫‰ºö**„ÄÇ

### Ëß£ÂÜ≥ÊñπÊ°à

Ëøô‰∏™Â∑•ÂÖ∑Â∞±ÊòØ‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òËÄåËÆæËÆ°ÁöÑ„ÄÇÂÆÉ‰ºöËá™Âä®ÂàÜÈ°µÁ°Æ‰øùÂÜÖÂÆπ‰∏ç‰ºöË¶ÜÁõñÊ∞¥Âç∞ÂíåÈ°µÁ†Å„ÄÇ‰Ω†ÂèØ‰ª•Áî®ÂõûËΩ¶Êù•ÊéßÂà∂ÊÆµËêΩÈó¥Ë∑ùÔºåÂàõÈÄ†‰Ω†ÊÉ≥Ë¶ÅÁöÑËßÜËßâÊïàÊûú„ÄÇ

## ‰ΩøÁî®ÊäÄÂ∑ß

‚Ä¢ ‰ΩøÁî®Ê†áÈ¢òÊåâÈíÆÂø´ÈÄüÊ∑ªÂä†Ê†áÈ¢òÊ†ºÂºè
‚Ä¢ ÊîØÊåÅ **Âä†Á≤ó**„ÄÅ*Êñú‰Ωì*„ÄÅ__‰∏ãÂàíÁ∫ø__„ÄÅ~~Âà†Èô§Á∫ø~~
‚Ä¢ ÊîØÊåÅÈ¢úËâ≤Ê†áËÆ∞Ôºö[color:#ff4757]Á∫¢Ëâ≤ÊñáÂ≠ó[/color]
‚Ä¢ Ëá™Âä®ÂàÜÈ°µÔºåÊô∫ËÉΩÊéíÁâà`;
            }

            // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            const textarea = document.getElementById('inputText');
            if (textarea) {
                textarea.addEventListener('input', updatePreview);
            }

            const fontSelect = document.getElementById('fontFamily');
            if (fontSelect) {
                fontSelect.addEventListener('change', updateFontDisplay);
            }

            const fontSizeInput = document.getElementById('fontSize');
            if (fontSizeInput) {
                fontSizeInput.addEventListener('change', regenerateIfNeeded);
            }

            const lineHeightInput = document.getElementById('lineHeight');
            if (lineHeightInput) {
                lineHeightInput.addEventListener('change', regenerateIfNeeded);
            }

            // Âª∂ËøüËá™Âä®ÁîüÊàêÈ¢ÑËßàÔºåÁ°Æ‰øùÊâÄÊúâÂÖÉÁ¥†ÈÉΩÂ∑≤Âä†ËΩΩ
            setTimeout(() => {
                try {
                    generatePages();
                } catch (e) {
                    console.error('Ëá™Âä®ÁîüÊàêÈ¢ÑËßàÂ§±Ë¥•:', e);
                }
            }, 500);
        });
    </script>
</body>

</html>