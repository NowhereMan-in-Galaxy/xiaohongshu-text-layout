<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦é•¿æ–‡æ’ç‰ˆå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .main-content {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .input-section {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .output-section {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background-color: #ff2442;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #e01f3d;
        }

        .secondary-btn {
            background-color: #666;
        }

        .secondary-btn:hover {
            background-color: #555;
        }

        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .page-preview {
            width: 300px;
            height: 533px;
            background: white;
            border: 1px solid #ddd;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .page-content {
            padding: 0;
            margin: 0;
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            word-wrap: break-word;
            word-break: break-all;
            overflow: hidden;
        }

        .page-content p {
            margin: 0;
            text-align: justify;
            word-break: break-all;
        }

        .page-number {
            position: absolute;
            bottom: 15px;
            right: 20px;
            color: #999;
            font-size: 12px;
        }

        .watermark {
            position: absolute;
            bottom: 15px;
            left: 20px;
            color: #ccc;
            font-size: 12px;
        }

        .settings {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .setting-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            min-width: 100px;
            font-size: 14px;
        }

        input[type="number"],
        input[type="text"] {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 200px;
        }

        .download-section {
            margin-top: 20px;
            text-align: center;
        }

        #canvas {
            display: none;
        }

        .tips {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            font-size: 13px;
            color: #856404;
        }

        .editor-toolbar {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 5px 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .toolbar-btn:hover {
            background: #5a6268;
        }

        .color-selector {
            display: flex;
            gap: 3px;
            margin-left: 10px;
        }

        .color-btn {
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
        }

        .markdown-preview {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }

        .page-header {
            padding: 15px 25px 0;
            font-weight: bold;
            color: #666;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .md-table {
            border-collapse: collapse;
            margin: 10px 0;
            width: 100%;
            font-size: 13px;
            background: #fff;
        }

        .md-table th,
        .md-table td {
            border: 1px solid #ddd;
            padding: 6px 10px;
            text-align: left;
        }

        .md-table th {
            background: #f5f5f5;
            font-weight: bold;
        }

        .md-table tr:nth-child(even) td {
            background: #fafafa;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>å°çº¢ä¹¦é•¿æ–‡æ’ç‰ˆå·¥å…·</h1>

        <div class="main-content">
            <div class="input-section">
                <h2>è¾“å…¥æ–‡æœ¬</h2>
                <div class="editor-toolbar">
                    <button class="toolbar-btn" onclick="insertHeading('#')" title="ä¸€çº§æ ‡é¢˜">H1</button>
                    <button class="toolbar-btn" onclick="insertHeading('##')" title="äºŒçº§æ ‡é¢˜">H2</button>
                    <button class="toolbar-btn" onclick="insertHeading('###')" title="ä¸‰çº§æ ‡é¢˜">H3</button>
                    <button class="toolbar-btn" onclick="insertMarkdown('**', '**')" title="åŠ ç²—">ğŸ’ª åŠ ç²—</button>
                    <button class="toolbar-btn" onclick="insertMarkdown('*', '*')" title="æ–œä½“"><em>I</em> æ–œä½“</button>
                    <button class="toolbar-btn" onclick="insertMarkdown('__', '__')" title="ä¸‹åˆ’çº¿"><u>U</u> ä¸‹åˆ’çº¿</button>
                    <button class="toolbar-btn" onclick="insertMarkdown('~~', '~~')" title="åˆ é™¤çº¿"><s>S</s> åˆ é™¤çº¿</button>
                    <div class="color-selector">
                        <div class="color-btn" style="background: #ff4757;" onclick="insertColor('#ff4757')" title="çº¢è‰²">
                        </div>
                        <div class="color-btn" style="background: #5352ed;" onclick="insertColor('#5352ed')" title="è“è‰²">
                        </div>
                        <div class="color-btn" style="background: #2ed573;" onclick="insertColor('#2ed573')" title="ç»¿è‰²">
                        </div>
                        <div class="color-btn" style="background: #ffa502;" onclick="insertColor('#ffa502')" title="æ©™è‰²">
                        </div>
                        <div class="color-btn" style="background: #ff6348;" onclick="insertColor('#ff6348')"
                            title="çŠç‘šè‰²"></div>
                        <div class="color-btn" style="background: #a55eea;" onclick="insertColor('#a55eea')" title="ç´«è‰²">
                        </div>
                    </div>
                </div>
                <textarea id="inputText" placeholder="è¯·è¾“å…¥æ‚¨è¦æ’ç‰ˆçš„é•¿æ–‡å†…å®¹..."></textarea>
                <div class="markdown-preview" id="markdownPreview" style="display:none;">
                    <strong>é¢„è§ˆï¼š</strong><br>
                    <div id="previewContent"></div>
                </div>

                <div class="settings">
                    <div class="setting-item">
                        <label>å­—ä½“å¤§å°ï¼š</label>
                        <input type="number" id="fontSize" value="13" min="12" max="20" title="è®¾ç½®å­—ä½“å¤§å°"
                            aria-label="å­—ä½“å¤§å°">
                        px
                    </div>
                    <div class="setting-item">
                        <label>è¡Œé«˜ï¼š</label>
                        <input type="number" id="lineHeight" value="1.8" min="1.2" max="2.5" step="0.1" title="è®¾ç½®è¡Œé«˜"
                            aria-label="è¡Œé«˜">
                    </div>
                    <div class="setting-item">
                        <label>æ°´å°æ–‡å­—ï¼š</label>
                        <input type="text" id="watermarkText" placeholder="è¾“å…¥æ°´å°æ–‡å­—ï¼ˆå¯é€‰ï¼‰" title="è®¾ç½®æ°´å°æ–‡å­—" aria-label="æ°´å°æ–‡å­—">
                    </div>
                    <div class="setting-item">
                        <label>èƒŒæ™¯é¢œè‰²ï¼š</label>
                        <select id="bgColor" title="é€‰æ‹©èƒŒæ™¯é¢œè‰²" aria-label="èƒŒæ™¯é¢œè‰²"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="white">çº¯ç™½</option>
                            <option value="cream">ç±³è‰²</option>
                            <option value="light-pink">æ·¡ç²‰è‰²</option>
                            <option value="light-blue">æ·¡è“è‰²</option>
                            <option value="light-green">æ·¡ç»¿è‰²</option>
                            <option value="light-yellow">æ·¡é»„è‰²</option>
                            <option value="light-purple">æ·¡ç´«è‰²</option>
                            <option value="light-gray">æ·¡ç°è‰²</option>
                            <option value="gradient1">æ¸å˜ç²‰</option>
                            <option value="gradient2">æ¸å˜è“</option>
                            <option value="gradient3">æ¸å˜ç´«</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>çº¹ç†æ•ˆæœï¼š</label>
                        <select id="bgTexture" title="é€‰æ‹©èƒŒæ™¯çº¹ç†" aria-label="èƒŒæ™¯çº¹ç†"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="none">æ— </option>
                            <option value="paper">çº¸å¼ çº¹ç†</option>
                            <option value="dots">ç‚¹é˜µ</option>
                            <option value="lines">æ¨ªçº¿</option>
                            <option value="grid">ç½‘æ ¼</option>
                            <option value="notebook">ç¬”è®°æœ¬</option>
                            <option value="memo">ä¾¿ç¬ºçº¹ç†</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>é£æ ¼é¢„è®¾ï¼š</label>
                        <select id="stylePreset" onchange="applyPreset()" title="é€‰æ‹©é£æ ¼é¢„è®¾" aria-label="é£æ ¼é¢„è®¾"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="custom">è‡ªå®šä¹‰</option>
                            <option value="classic-memo">ç»å…¸å¤‡å¿˜å½•</option>
                            <option value="modern-note">ç°ä»£ç¬”è®°</option>
                            <option value="vintage-paper">å¤å¤çº¸å¼ </option>
                            <option value="minimal-clean">ç®€çº¦æ¸…æ–°</option>
                            <option value="warm-journal">æ¸©æš–æ—¥è®°</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>å›¾ç‰‡æ¯”ä¾‹ï¼š</label>
                        <select id="aspectRatio" onchange="updatePreviewSize()" title="é€‰æ‹©å›¾ç‰‡æ¯”ä¾‹" aria-label="å›¾ç‰‡æ¯”ä¾‹"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="2:3">2:3 ç«–ç‰ˆ</option>
                            <option value="3:4">3:4 å°çº¢ä¹¦æ¨è</option>
                            <option value="1:1">1:1 æ­£æ–¹å½¢</option>
                            <option value="4:3">4:3 æ¨ªå‘</option>
                            <option value="16:9">16:9 å®½å±</option>
                            <option value="9:16">9:16 ç«–å±</option>
                            <option value="custom">è‡ªå®šä¹‰å°ºå¯¸</option>
                        </select>
                    </div>
                    <div class="setting-item" id="customSizeOptions" style="display:none;">
                        <label>è‡ªå®šä¹‰å®½åº¦ï¼š</label>
                        <input type="number" id="customWidth" value="900" min="300" max="2000"> px
                        <label style="margin-left: 15px;">é«˜åº¦ï¼š</label>
                        <input type="number" id="customHeight" value="1600" min="300" max="2000"> px
                    </div>
                    <div class="setting-item">
                        <label>å­—ä½“é€‰æ‹©ï¼š</label>
                        <select id="fontFamily" title="é€‰æ‹©å­—ä½“" aria-label="å­—ä½“é€‰æ‹©"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="default">ç³»ç»Ÿé»˜è®¤</option>
                            <option value="SimHei">é»‘ä½“</option>
                            <option value="SimSun">å®‹ä½“</option>
                            <option value="KaiTi">æ¥·ä½“</option>
                            <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                            <option value="PingFang SC">è‹¹æ–¹</option>
                            <option value="Hiragino Sans GB">å†¬é’é»‘ä½“</option>
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="custom">ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“</option>
                        </select>
                    </div>
                    <div class="setting-item" id="customFontUpload" style="display:none;">
                        <label>å­—ä½“æ–‡ä»¶ï¼š</label>
                        <input type="file" id="fontFile" accept=".ttf,.otf,.woff,.woff2"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                        <button type="button" onclick="loadCustomFont()" class="toolbar-btn"
                            style="margin-left: 10px;">åŠ è½½å­—ä½“</button>
                    </div>
                    <div class="setting-item">
                        <label>å­—ä½“ä¸‹è½½ï¼š</label>
                        <button type="button" onclick="showFontDownloadInfo()" class="toolbar-btn">è·å–å­—ä½“èµ„æº</button>
                        <span style="font-size: 12px; color: #666; margin-left: 10px;">è·å–å…è´¹ä¸­æ–‡å­—ä½“ä¸‹è½½é“¾æ¥</span>
                    </div>
                    <div class="setting-item">
                        <label>é¡µçœ‰è®¾ç½®ï¼š</label>
                        <input type="checkbox" id="enableHeader" onchange="toggleHeaderOptions()" title="å¯ç”¨å›ºå®šé¡µçœ‰"
                            aria-label="å¯ç”¨å›ºå®šé¡µçœ‰">
                        <span>å¯ç”¨å›ºå®šé¡µçœ‰</span>
                    </div>
                    <div class="setting-item" id="headerOptions" style="display:none;">
                        <label>é¡µçœ‰æ–‡å­—ï¼š</label>
                        <input type="text" id="headerText" placeholder="è¾“å…¥é¡µçœ‰æ–‡å­—"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                    </div>
                    <div class="setting-item" id="headerStyleOptions" style="display:none;">
                        <label>é¡µçœ‰æ ·å¼ï¼š</label>
                        <select id="headerStyle"
                            style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px;">
                            <option value="center">å±…ä¸­</option>
                            <option value="left">å·¦å¯¹é½</option>
                            <option value="right">å³å¯¹é½</option>
                        </select>
                    </div>
                </div>

                <div class="controls">
                    <button onclick="generatePages()">ç”Ÿæˆæ’ç‰ˆ</button>
                    <button class="secondary-btn" onclick="togglePreview()">åˆ‡æ¢é¢„è§ˆ</button>
                    <button class="secondary-btn" onclick="clearAll()">æ¸…ç©º</button>
                </div>

                <div class="tips">
                    <strong>ä½¿ç”¨æç¤ºï¼š</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>è¾“å…¥æ–‡æœ¬åç‚¹å‡»"ç”Ÿæˆæ’ç‰ˆ"</li>
                        <li>æ™ºèƒ½åˆ†é¡µï¼šç³»ç»Ÿè‡ªåŠ¨åˆ†é¡µï¼Œç¡®ä¿å†…å®¹ä¸è¦†ç›–æ°´å°å’Œé¡µç </li>
                        <li>å›è½¦æ§åˆ¶ï¼šä½¿ç”¨å›è½¦æ§åˆ¶æ®µè½é—´è·å’Œç©ºç™½ï¼Œå¤šä¸ªå›è½¦åˆ›å»ºæ›´å¤šç©ºç™½</li>
                        <li>å†…å®¹ä¿æŠ¤ï¼šé¡µé¢å®¹é‡æ™ºèƒ½è®¡ç®—ï¼Œé¿å…å†…å®¹è¶…å‡ºèŒƒå›´</li>
                        <li>æ”¯æŒMarkdownæ ¼å¼ï¼š# ä¸€çº§æ ‡é¢˜ ## äºŒçº§æ ‡é¢˜ ### ä¸‰çº§æ ‡é¢˜ **åŠ ç²—** *æ–œä½“* __ä¸‹åˆ’çº¿__ [color:#ff0000]çº¢è‰²[/color]</li>
                        <li>å¯ä½¿ç”¨å·¥å…·æ å¿«é€Ÿæ·»åŠ æ ¼å¼ï¼Œæˆ–æ‰‹åŠ¨ç¼–å†™Markdown</li>
                        <li>æ ‡é¢˜åŠŸèƒ½ï¼šç‚¹å‡»H1/H2/H3æŒ‰é’®å¿«é€Ÿæ·»åŠ æ ‡é¢˜ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥#ã€##ã€###</li>
                        <li>ç‚¹å‡»"åˆ‡æ¢é¢„è§ˆ"æŸ¥çœ‹æ ¼å¼æ•ˆæœ</li>
                        <li>ç‚¹å‡»"ä¸‹è½½å½“å‰é¡µ"å¯ä¿å­˜å•å¼ å›¾ç‰‡</li>
                        <li>ç‚¹å‡»"ä¸‹è½½æ‰€æœ‰é¡µ"å¯æ‰¹é‡ä¿å­˜</li>
                    </ul>
                </div>
            </div>

            <div class="output-section">
                <h2>é¢„è§ˆæ•ˆæœ</h2>
                <div id="previewContainer" class="preview-container"></div>
                <div class="download-section" id="downloadSection" style="display: none;">
                    <button onclick="downloadCurrentPage()">ä¸‹è½½å½“å‰é¡µ</button>
                    <button onclick="downloadAllPages()">ä¸‹è½½æ‰€æœ‰é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // å…¨å±€å˜é‡å£°æ˜
        let currentPages = [];
        let currentPageIndex = 0;

        // æ¢å¤æœ€åˆçš„åˆ†é¡µå‡½æ•°ï¼šæ®µè½æ•´ä½“åˆ†é¡µï¼Œä¸åˆ†è¡Œå¡«æ»¡
        function splitTextIntoPages(text) {
            try {
                const fontSize = parseInt(document.getElementById('fontSize').value) || 13;
                const lineHeight = parseFloat(document.getElementById('lineHeight').value) || 1.8;
                const enableHeader = document.getElementById('enableHeader').checked || false;
                const aspectRatio = document.getElementById('aspectRatio').value || '2:3';
                const dimensions = getAspectRatioDimensions(aspectRatio);

                const pageHeight = dimensions.preview.height;
                const pageWidth = dimensions.preview.width;

                const padding = {
                    top: 15,
                    bottom: 20,
                    left: 20,
                    right: 20
                };
                const headerHeight = enableHeader ? 30 : 0;
                const footerHeight = 30;
                const availableHeight = pageHeight - padding.top - padding.bottom - headerHeight - footerHeight;
                const availableWidth = pageWidth - padding.left - padding.right;
                const lineHeightPx = fontSize * lineHeight;
                const maxLinesPerPage = Math.max(1, Math.floor(availableHeight / lineHeightPx) - 1);
                const charsPerLine = Math.floor(availableWidth / (fontSize * 0.9));

                const paragraphs = text.split('\n');
                // å¤„ç†æ¯ä¸ªæ®µè½ï¼Œè®¡ç®—å®é™…å ç”¨çš„è¡Œæ•°
                const processedParagraphs = paragraphs.map(paragraph => {
                    if (paragraph.trim() === '') {
                        // ç©ºè¡Œå ä¸€è¡Œ
                        return {
                            text: '',
                            lines: 1,
                            isEmptyLine: true
                        };
                    }
                    // ç§»é™¤Markdownæ ‡è®°æ¥è®¡ç®—å®é™…é•¿åº¦
                    const plainText = paragraph
                        .replace(/\*\*(.*?)\*\*/g, '$1')
                        .replace(/\*(.*?)\*/g, '$1')
                        .replace(/__(.*?)__/g, '$1')
                        .replace(/~~(.*?)~~/g, '$1')
                        .replace(/\[color:#[a-fA-F0-9]{6}\](.*?)\[\/color\]/g, '$1');
                    // è®¡ç®—è¿™ä¸ªæ®µè½éœ€è¦å¤šå°‘è¡Œ
                    const linesNeeded = Math.ceil(plainText.length / charsPerLine) || 1;
                    return {
                        text: paragraph,
                        lines: linesNeeded,
                        isEmptyLine: false
                    };
                });
                // åˆ†é¡µ
                const pages = [];
                let currentPage = [];
                let currentPageLines = 0;
                for (let i = 0; i < processedParagraphs.length; i++) {
                    const paragraph = processedParagraphs[i];
                    // æ£€æŸ¥å½“å‰æ®µè½æ˜¯å¦èƒ½æ”¾å…¥å½“å‰é¡µ
                    if (currentPageLines + paragraph.lines > maxLinesPerPage && currentPage.length > 0) {
                        // å½“å‰é¡µå·²æ»¡ï¼Œåˆ›å»ºæ–°é¡µ
                        pages.push(currentPage.map(p => p.text));
                        currentPage = [paragraph];
                        currentPageLines = paragraph.lines;
                    } else {
                        // æ·»åŠ åˆ°å½“å‰é¡µ
                        currentPage.push(paragraph);
                        currentPageLines += paragraph.lines;
                    }
                }
                // æ·»åŠ æœ€åä¸€é¡µ
                if (currentPage.length > 0) {
                    pages.push(currentPage.map(p => p.text));
                }
                if (pages.length === 0) {
                    pages.push(['']);
                }
                return pages;
            } catch (error) {
                console.error('åˆ†é¡µé”™è¯¯:', error);
                return [['']];
            }
        }

        function parseMarkdown(text) {
            // 1. å…ˆæ•´ä½“è¯†åˆ«æ‰€æœ‰è¡¨æ ¼å—ï¼Œæ›¿æ¢ä¸ºå”¯ä¸€å ä½ç¬¦
            let tableMap = {};
            let tableIdx = 0;
            text = text.replace(/((?:^\s*\|.*\|.*(?:\n|$))+)/gm, function (tableBlock) {
                const lines = tableBlock.trim().split('\n');
                if (lines.length < 2) return tableBlock;
                if (!/^\s*\|?\s*(:?-+:?\s*\|)+\s*$/.test(lines[1])) return tableBlock;
                const key = `__TABLE_BLOCK_${tableIdx}__`;
                tableMap[key] = tableBlock;
                tableIdx++;
                return key;
            });
            // 2. å…¶å®ƒMarkdownå¤„ç†
            text = text
                // å¤„ç†æ ‡é¢˜ (å¿…é¡»åœ¨å…¶ä»–æ ¼å¼ä¹‹å‰å¤„ç†)
                .replace(/^### (.*$)/gim, '<h3 style="margin: 0; margin-bottom: 0.3em; font-size: 0.9em; font-weight: bold; color: #333;">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 style="margin: 0; margin-bottom: 0.3em; font-size: 1.1em; font-weight: bold; color: #333;">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 style="margin: 0; margin-bottom: 0.3em; font-size: 1.2em; font-weight: bold; color: #333;">$1</h1>')
                // å¤„ç†å…¶ä»–æ ¼å¼
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/__(.*?)__/g, '<u>$1</u>')
                .replace(/~~(.*?)~~/g, '<del>$1</del>')
                .replace(/\[color:(#[a-fA-F0-9]{6})\](.*?)\[\/color\]/g, '<span style="color:$1">$2</span>');
            // 3. æ›¿æ¢å›è¡¨æ ¼HTML
            Object.keys(tableMap).forEach(key => {
                text = text.replace(key, renderMarkdownTable(tableMap[key].split('\n')));
            });
            return text;
        }

        // æ¸²æŸ“Markdownè¡¨æ ¼ä¸ºHTML
        function renderMarkdownTable(lines) {
            if (lines.length < 2) return lines.join('<br>');
            const headerCells = lines[0].split('|').slice(1, -1).map(cell => cell.trim());
            const rows = lines.slice(2).map(row => row.split('|').slice(1, -1).map(cell => cell.trim()));
            let html = '<table class="md-table"><thead><tr>';
            headerCells.forEach(cell => { html += `<th>${parseMarkdown(cell)}</th>`; });
            html += '</tr></thead><tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => { html += `<td>${parseMarkdown(cell)}</td>`; });
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        // æ”¹è¿›çš„æ ¼å¼åŒ–æ–‡æœ¬å‡½æ•°
        function formatTextWithParagraphs(lines) {
            return lines.map((line, index) => {
                if (line.trim() === '') {
                    // ç©ºè¡Œä¿æŒå›ºå®šé«˜åº¦ï¼Œä½†å‡å°‘é«˜åº¦
                    return '<p style="margin: 0; height: 0.5em;">&nbsp;</p>';
                } else {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ ‡é¢˜
                    const isHeading = /^#{1,3}\s/.test(line);

                    if (isHeading) {
                        // æ ‡é¢˜ä¸éœ€è¦é¢å¤–çš„åŒ…è£…
                        return parseMarkdown(line);
                    } else {
                        // æ­£å¸¸æ®µè½ï¼Œå‡å°‘æ®µè½é—´è·
                        const marginBottom = index === lines.length - 1 ? '0' : '0.3em';
                        return `<p style="margin: 0; margin-bottom: ${marginBottom}; text-align: justify; word-break: break-all;">${parseMarkdown(line)}</p>`;
                    }
                }
            }).join('');
        }

        function getBackgroundColor(colorOption) {
            switch (colorOption) {
                case 'cream': return '#FFF8E7';
                case 'light-pink': return '#FDF2F8';
                case 'light-blue': return '#EFF6FF';
                case 'light-green': return '#F0FDF4';
                case 'light-yellow': return '#FEFCE8';
                case 'light-purple': return '#FAF5FF';
                case 'light-gray': return '#F9FAFB';
                case 'gradient1': return 'linear-gradient(135deg, #FFE0EC 0%, #FFF5E0 100%)';
                case 'gradient2': return 'linear-gradient(135deg, #E0F0FF 0%, #F0E0FF 100%)';
                case 'gradient3': return 'linear-gradient(135deg, #F5E0FF 0%, #E0E8FF 100%)';
                default: return 'white';
            }
        }

        function getTextureOverlay(textureOption) {
            switch (textureOption) {
                case 'paper':
                    return 'repeating-linear-gradient(123deg, transparent, transparent 2px, rgba(0,0,0,0.008) 2px, rgba(0,0,0,0.008) 3px), repeating-linear-gradient(27deg, transparent, transparent 1px, rgba(0,0,0,0.005) 1px, rgba(0,0,0,0.005) 2px), radial-gradient(circle at 20% 50%, rgba(0,0,0,0.01) 0%, transparent 50%), radial-gradient(circle at 80% 30%, rgba(0,0,0,0.01) 0%, transparent 50%)';
                case 'dots':
                    return 'radial-gradient(circle at 10px 10px, rgba(0,0,0,0.1) 1px, transparent 0), radial-gradient(circle at 10px 10px, rgba(0,0,0,0.1) 1px, transparent 0)';
                case 'lines':
                    return 'repeating-linear-gradient(0deg, transparent, transparent 23px, rgba(0,0,0,0.1) 24px)';
                case 'grid':
                    return 'repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(0,0,0,0.05) 20px), repeating-linear-gradient(90deg, transparent, transparent 19px, rgba(0,0,0,0.05) 20px)';
                case 'notebook':
                    return 'repeating-linear-gradient(0deg, transparent, transparent 23px, rgba(0,0,0,0.1) 24px), linear-gradient(90deg, #ff69b4 80px, #ff69b4 82px, transparent 82px)';
                case 'memo':
                    return 'linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%), linear-gradient(-45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%)';
                default:
                    return null;
            }
        }

        function applyBackground(element, bgColor, bgTexture) {
            const baseColor = getBackgroundColor(bgColor);
            element.style.background = baseColor;

            if (bgTexture !== 'none') {
                const textureOverlay = getTextureOverlay(bgTexture);
                if (textureOverlay) {
                    element.style.background = textureOverlay + ', ' + baseColor;
                    if (bgTexture === 'dots') {
                        element.style.backgroundSize = '20px 20px, 20px 20px';
                    } else if (bgTexture === 'memo') {
                        element.style.backgroundSize = '10px 10px, 10px 10px';
                    }
                }
            }
        }

        function applyPreset() {
            const preset = document.getElementById('stylePreset').value;
            const bgColorSelect = document.getElementById('bgColor');
            const bgTextureSelect = document.getElementById('bgTexture');

            switch (preset) {
                case 'classic-memo':
                    bgColorSelect.value = 'light-yellow';
                    bgTextureSelect.value = 'lines';
                    break;
                case 'modern-note':
                    bgColorSelect.value = 'white';
                    bgTextureSelect.value = 'dots';
                    break;
                case 'vintage-paper':
                    bgColorSelect.value = 'cream';
                    bgTextureSelect.value = 'paper';
                    break;
                case 'minimal-clean':
                    bgColorSelect.value = 'white';
                    bgTextureSelect.value = 'none';
                    break;
                case 'warm-journal':
                    bgColorSelect.value = 'light-pink';
                    bgTextureSelect.value = 'memo';
                    break;
            }
        }

        function getAspectRatioDimensions(ratio) {
            const previewBase = 300;
            const downloadBase = 900;

            switch (ratio) {
                case '1:1':
                    return {
                        preview: { width: previewBase, height: previewBase },
                        download: { width: downloadBase, height: downloadBase }
                    };
                case '3:4':
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 4 / 3) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 4 / 3) }
                    };
                case '4:3':
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 3 / 4) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 3 / 4) }
                    };
                case '16:9':
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 9 / 16) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 9 / 16) }
                    };
                case '9:16':
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 16 / 9) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 16 / 9) }
                    };
                case '2:3':
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 3 / 2) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 3 / 2) }
                    };
                case 'custom':
                    const customWidth = parseInt(document.getElementById('customWidth').value) || 900;
                    const customHeight = parseInt(document.getElementById('customHeight').value) || 1600;
                    const scale = previewBase / customWidth;
                    return {
                        preview: { width: previewBase, height: Math.round(customHeight * scale) },
                        download: { width: customWidth, height: customHeight }
                    };
                default:
                    return {
                        preview: { width: previewBase, height: Math.round(previewBase * 3 / 2) },
                        download: { width: downloadBase, height: Math.round(downloadBase * 3 / 2) }
                    };
            }
        }

        function updatePreviewSize() {
            const aspectRatio = document.getElementById('aspectRatio').value;
            const customOptions = document.getElementById('customSizeOptions');

            customOptions.style.display = aspectRatio === 'custom' ? 'block' : 'none';

            const pagePreviewElements = document.querySelectorAll('.page-preview');
            const dimensions = getAspectRatioDimensions(aspectRatio);

            pagePreviewElements.forEach(element => {
                element.style.width = dimensions.preview.width + 'px';
                element.style.height = dimensions.preview.height + 'px';
            });

            const inputText = document.getElementById('inputText').value;
            if (inputText.trim() && currentPages.length > 0) {
                generatePages();
            }
        }

        function updateFontDisplay() {
            const fontFamily = document.getElementById('fontFamily').value;
            const customFontUpload = document.getElementById('customFontUpload');

            customFontUpload.style.display = fontFamily === 'custom' ? 'block' : 'none';

            const pageContentElements = document.querySelectorAll('.page-content');
            pageContentElements.forEach(element => {
                if (fontFamily === 'default') {
                    element.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif';
                } else if (fontFamily !== 'custom') {
                    element.style.fontFamily = `"${fontFamily}", -apple-system, BlinkMacSystemFont, sans-serif`;
                }
            });
        }

        function regenerateIfNeeded() {
            const inputText = document.getElementById('inputText').value;
            if (inputText.trim() && currentPages.length > 0) {
                generatePages();
            }
        }

        function loadCustomFont() {
            const fileInput = document.getElementById('fontFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('è¯·é€‰æ‹©å­—ä½“æ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const fontData = e.target.result;
                const fontFamily = 'CustomFont_' + Date.now();

                const style = document.createElement('style');
                style.textContent = `
                    @font-face {
                        font-family: "${fontFamily}";
                        src: url(${fontData});
                    }
                `;
                document.head.appendChild(style);

                const pageContentElements = document.querySelectorAll('.page-content');
                pageContentElements.forEach(element => {
                    element.style.fontFamily = `"${fontFamily}", sans-serif`;
                });

                alert('å­—ä½“åŠ è½½æˆåŠŸï¼');
            };

            reader.readAsDataURL(file);
        }

        function showFontDownloadInfo() {
            const fontInfo = `
                <div style="max-width: 500px; text-align: left;">
                    <h3>å…è´¹ä¸­æ–‡å­—ä½“èµ„æºæ¨èï¼š</h3>
                    <br>
                    <strong>1. æ€æºå­—ä½“ç³»åˆ—ï¼š</strong><br>
                    â€¢ æ€æºé»‘ä½“ (Source Han Sans)<br>
                    â€¢ æ€æºå®‹ä½“ (Source Han Serif)<br>
                    â€¢ ä¸‹è½½åœ°å€ï¼šGitHub æœç´¢ "adobe-fonts"<br>
                    <br>
                    <strong>2. ç«™é…·å­—ä½“ç³»åˆ—ï¼š</strong><br>
                    â€¢ ç«™é…·é«˜ç«¯é»‘ã€ç«™é…·å¿«ä¹ä½“ã€ç«™é…·æ–‡è‰ºä½“<br>
                    â€¢ ä¸‹è½½åœ°å€ï¼šç«™é…·ç½‘ (zcool.com.cn)<br>
                    <br>
                    <strong>3. æ–¹æ­£å­—åº“å…è´¹å­—ä½“ï¼š</strong><br>
                    â€¢ æ–¹æ­£é»‘ä½“ã€æ–¹æ­£æ¥·ä½“ã€æ–¹æ­£ä»¿å®‹<br>
                    â€¢ ä¸‹è½½åœ°å€ï¼šæ–¹æ­£å­—åº“å®˜ç½‘<br>
                    <br>
                    <strong>4. æ–‡æ³‰é©¿å­—ä½“ï¼š</strong><br>
                    â€¢ æ–‡æ³‰é©¿å¾®ç±³é»‘ã€æ–‡æ³‰é©¿æ­£é»‘<br>
                    â€¢ ä¸‹è½½åœ°å€ï¼šwenq.org<br>
                    <br>
                    <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                    1. ä¸‹è½½å­—ä½“æ–‡ä»¶(.ttf, .otfæ ¼å¼)<br>
                    2. åœ¨"å­—ä½“é€‰æ‹©"ä¸­é€‰æ‹©"ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“"<br>
                    3. ç‚¹å‡»"é€‰æ‹©æ–‡ä»¶"ä¸Šä¼ å­—ä½“<br>
                    4. ç‚¹å‡»"åŠ è½½å­—ä½“"å³å¯ä½¿ç”¨<br>
                </div>
            `;

            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            `;

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'å…³é—­';
            closeBtn.style.cssText = `
                position: absolute;
                top: 10px;
                right: 15px;
                background: #ff2442;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
            `;
            closeBtn.onclick = () => document.body.removeChild(popup);

            content.innerHTML = fontInfo;
            content.appendChild(closeBtn);
            popup.appendChild(content);
            document.body.appendChild(popup);
        }

        function toggleHeaderOptions() {
            const enableHeader = document.getElementById('enableHeader').checked;
            const headerOptions = document.getElementById('headerOptions');
            const headerStyleOptions = document.getElementById('headerStyleOptions');

            headerOptions.style.display = enableHeader ? 'block' : 'none';
            headerStyleOptions.style.display = enableHeader ? 'block' : 'none';
        }

        // æ”¹è¿›çš„ç”Ÿæˆé¡µé¢å‡½æ•°
        function generatePages() {
            try {
                const inputText = document.getElementById('inputText').value;

                if (!inputText || !inputText.trim()) {
                    alert('è¯·è¾“å…¥è¦æ’ç‰ˆçš„æ–‡æœ¬');
                    return;
                }

                const fontSize = document.getElementById('fontSize').value;
                const lineHeight = document.getElementById('lineHeight').value;
                const watermarkText = document.getElementById('watermarkText').value;
                const bgColor = document.getElementById('bgColor').value;
                const bgTexture = document.getElementById('bgTexture').value;
                const fontFamily = document.getElementById('fontFamily').value;
                const enableHeader = document.getElementById('enableHeader').checked;
                const headerText = document.getElementById('headerText').value;
                const headerStyle = document.getElementById('headerStyle').value;

                currentPages = splitTextIntoPages(inputText);

                const previewContainer = document.getElementById('previewContainer');
                previewContainer.innerHTML = '';

                const aspectRatio = document.getElementById('aspectRatio').value;
                const dimensions = getAspectRatioDimensions(aspectRatio);

                currentPages.forEach((pageTextArray, index) => {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'page-preview';
                    pageDiv.setAttribute('data-page-index', index);
                    pageDiv.style.width = dimensions.preview.width + 'px';
                    pageDiv.style.height = dimensions.preview.height + 'px';
                    pageDiv.style.position = 'relative';
                    pageDiv.style.overflow = 'hidden';
                    applyBackground(pageDiv, bgColor, bgTexture);

                    // åˆ›å»ºå†…å®¹å®¹å™¨
                    const contentWrapper = document.createElement('div');
                    contentWrapper.style.cssText = `
                        position: absolute;
                        top: ${enableHeader && headerText.trim() ? '70px' : '30px'};
                        left: 25px;
                        right: 25px;
                        bottom: 55px;
                        overflow: hidden;
                    `;

                    // æ·»åŠ é¡µçœ‰
                    if (enableHeader && headerText.trim()) {
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'page-header';
                        headerDiv.style.cssText = `
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            padding: 15px 25px;
                            font-size: ${Math.max(parseInt(fontSize) - 2, 12)}px;
                            font-weight: bold;
                            color: #666;
                            text-align: ${headerStyle};
                            border-bottom: 1px solid #eee;
                            background: rgba(255, 255, 255, 0.5);
                        `;

                        if (fontFamily === 'default') {
                            headerDiv.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif';
                        } else if (fontFamily !== 'custom') {
                            headerDiv.style.fontFamily = `"${fontFamily}", -apple-system, BlinkMacSystemFont, sans-serif`;
                        }

                        headerDiv.textContent = headerText;
                        pageDiv.appendChild(headerDiv);
                    }

                    // æ·»åŠ å†…å®¹
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'page-content';
                    contentDiv.style.cssText = `
                        font-size: ${fontSize}px;
                        line-height: ${lineHeight};
                        color: #333;
                        word-wrap: break-word;
                        word-break: break-all;
                    `;

                    if (fontFamily === 'default') {
                        contentDiv.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif';
                    } else if (fontFamily !== 'custom') {
                        contentDiv.style.fontFamily = `"${fontFamily}", -apple-system, BlinkMacSystemFont, sans-serif`;
                    }

                    contentDiv.innerHTML = formatTextWithParagraphs(pageTextArray);
                    contentWrapper.appendChild(contentDiv);
                    pageDiv.appendChild(contentWrapper);

                    // æ·»åŠ é¡µç 
                    const pageNumber = document.createElement('div');
                    pageNumber.className = 'page-number';
                    pageNumber.style.cssText = `
                        position: absolute;
                        bottom: 15px;
                        right: 20px;
                        color: #999;
                        font-size: 12px;
                    `;
                    pageNumber.textContent = `${index + 1}/${currentPages.length}`;
                    pageDiv.appendChild(pageNumber);

                    // æ·»åŠ æ°´å°
                    if (watermarkText) {
                        const watermark = document.createElement('div');
                        watermark.className = 'watermark';
                        watermark.style.cssText = `
                            position: absolute;
                            bottom: 15px;
                            left: 20px;
                            color: #ccc;
                            font-size: 12px;
                        `;
                        watermark.textContent = watermarkText;
                        pageDiv.appendChild(watermark);
                    }

                    // ç‚¹å‡»é€‰ä¸­æ•ˆæœ
                    pageDiv.onclick = () => {
                        currentPageIndex = index;
                        document.querySelectorAll('.page-preview').forEach(p => p.style.border = '1px solid #ddd');
                        pageDiv.style.border = '2px solid #ff2442';
                    };

                    previewContainer.appendChild(pageDiv);
                });

                if (currentPages.length > 0) {
                    document.getElementById('downloadSection').style.display = 'block';
                }
            } catch (error) {
                console.error('ç”Ÿæˆé¡µé¢é”™è¯¯:', error);
                alert('ç”Ÿæˆé¡µé¢æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„è¾“å…¥');
            }
        }

        // html2canvasä¸‹è½½å‡½æ•°
        function downloadPageByHtml2Canvas(pageIndex) {
            const pageElement = document.querySelector(`[data-page-index="${pageIndex}"]`);
            if (!pageElement) return;
            html2canvas(pageElement, {
                scale: 4, // æé«˜å¯¼å‡ºæ¸…æ™°åº¦
                useCORS: true
            }).then(canvas => {
                const url = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = url;
                a.download = `å°çº¢ä¹¦æ’ç‰ˆ_ç¬¬${pageIndex + 1}é¡µ.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        }

        function downloadCurrentPage() {
            downloadPageByHtml2Canvas(currentPageIndex);
        }

        function downloadAllPages() {
            if (confirm(`ç¡®å®šè¦ä¸‹è½½å…¨éƒ¨ ${currentPages.length} é¡µå—ï¼Ÿ`)) {
                let delay = 0;
                currentPages.forEach((_, index) => {
                    setTimeout(() => downloadPageByHtml2Canvas(index), delay);
                    delay += 800;
                });
            }
        }

        function clearAll() {
            document.getElementById('inputText').value = '';
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('downloadSection').style.display = 'none';
            currentPages = [];
            currentPageIndex = 0;
        }

        function insertHeading(level) {
            const textarea = document.getElementById('inputText');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            // è·å–å½“å‰è¡Œçš„å†…å®¹
            const lines = textarea.value.split('\n');
            let currentLineIndex = 0;
            let currentPos = 0;

            for (let i = 0; i < lines.length; i++) {
                if (currentPos <= start && start <= currentPos + lines[i].length) {
                    currentLineIndex = i;
                    break;
                }
                currentPos += lines[i].length + 1; // +1 for newline
            }

            if (selectedText) {
                // å¦‚æœæœ‰é€‰ä¸­çš„æ–‡æœ¬ï¼Œå°†å…¶è½¬æ¢ä¸ºæ ‡é¢˜
                const replacement = level + ' ' + selectedText;
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.selectionStart = start;
                textarea.selectionEnd = start + replacement.length;
            } else {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåœ¨å½“å‰è¡Œå¼€å¤´æ’å…¥æ ‡é¢˜æ ¼å¼
                const currentLine = lines[currentLineIndex];
                const lineStart = currentPos;
                const lineEnd = lineStart + currentLine.length;

                // æ£€æŸ¥å½“å‰è¡Œæ˜¯å¦å·²ç»æ˜¯æ ‡é¢˜
                if (currentLine.match(/^#{1,3}\s/)) {
                    // å¦‚æœå·²ç»æ˜¯æ ‡é¢˜ï¼Œæ›¿æ¢æ ‡é¢˜çº§åˆ«
                    const newLine = level + ' ' + currentLine.replace(/^#{1,3}\s/, '');
                    textarea.value = textarea.value.substring(0, lineStart) + newLine + textarea.value.substring(lineEnd);
                    textarea.selectionStart = lineStart;
                    textarea.selectionEnd = lineStart + newLine.length;
                } else {
                    // å¦‚æœä¸æ˜¯æ ‡é¢˜ï¼Œåœ¨è¡Œé¦–æ·»åŠ æ ‡é¢˜æ ¼å¼
                    const newLine = level + ' ' + currentLine;
                    textarea.value = textarea.value.substring(0, lineStart) + newLine + textarea.value.substring(lineEnd);
                    textarea.selectionStart = lineStart + level.length + 1;
                    textarea.selectionEnd = lineStart + level.length + 1;
                }
            }
            textarea.focus();
            updatePreview();
        }

        function insertMarkdown(startTag, endTag) {
            const textarea = document.getElementById('inputText');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            if (selectedText) {
                const replacement = startTag + selectedText + endTag;
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.selectionStart = start;
                textarea.selectionEnd = start + replacement.length;
            } else {
                const replacement = startTag + 'è¯·è¾“å…¥æ–‡å­—' + endTag;
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.selectionStart = start + startTag.length;
                textarea.selectionEnd = start + startTag.length + 4;
            }
            textarea.focus();
            updatePreview();
        }

        function insertColor(color) {
            const textarea = document.getElementById('inputText');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            const startTag = `[color:${color}]`;
            const endTag = '[/color]';

            if (selectedText) {
                const replacement = startTag + selectedText + endTag;
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.selectionStart = start;
                textarea.selectionEnd = start + replacement.length;
            } else {
                const replacement = startTag + 'è¯·è¾“å…¥æ–‡å­—' + endTag;
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.selectionStart = start + startTag.length;
                textarea.selectionEnd = start + startTag.length + 4;
            }
            textarea.focus();
            updatePreview();
        }

        function togglePreview() {
            const preview = document.getElementById('markdownPreview');
            if (preview.style.display === 'none') {
                preview.style.display = 'block';
                updatePreview();
            } else {
                preview.style.display = 'none';
            }
        }

        function updatePreview() {
            const inputText = document.getElementById('inputText').value;
            const previewContent = document.getElementById('previewContent');
            const preview = document.getElementById('markdownPreview');

            if (preview.style.display !== 'none') {
                previewContent.innerHTML = parseMarkdown(inputText.replace(/\n/g, '<br>'));
            }
        }

        // DOMContentLoaded äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function () {
            // è®¾ç½®ç¤ºä¾‹æ–‡æœ¬
            const inputText = document.getElementById('inputText');
            if (inputText) {
                inputText.value = `# å°çº¢ä¹¦é•¿æ–‡æ’ç‰ˆå·¥å…·ä½¿ç”¨æŒ‡å—

è¿™æ˜¯ä¸€ä¸ª**ç¤ºä¾‹æ–‡æœ¬**ã€‚å°çº¢ä¹¦æ˜¯ä¸€ä¸ªç”Ÿæ´»æ–¹å¼åˆ†äº«å¹³å°ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å›¾ç‰‡ã€è§†é¢‘å’Œæ–‡å­—è®°å½•ç”Ÿæ´»ç‚¹æ»´ï¼Œå‘ç°ç¾å¥½äº‹ç‰©ã€‚

## å¹³å°ç‰¹è‰²

åœ¨è¿™ä¸ªå¹³å°ä¸Šï¼Œä½ å¯ä»¥æ‰¾åˆ°å„ç§*ç”Ÿæ´»çµæ„Ÿ*ã€‚ä»[color:#ff4757]ç¾é£Ÿåˆ¶ä½œ[/color]åˆ°æ—…è¡Œæ”»ç•¥ï¼Œä»æŠ¤è‚¤å¿ƒå¾—åˆ°ç©¿æ­æŠ€å·§ï¼Œæ¯ä¸ªäººéƒ½èƒ½åœ¨è¿™é‡Œæ‰¾åˆ°è‡ªå·±æ„Ÿå…´è¶£çš„å†…å®¹ã€‚

### åˆ›ä½œè€…åˆ†äº«

åˆ›ä½œè€…ä»¬ç”¨å¿ƒåˆ†äº«ç€è‡ªå·±çš„ç»éªŒå’Œè§è§£ã€‚ä»–ä»¬é€šè¿‡__ç²¾ç¾çš„å›¾ç‰‡__å’Œè¯¦ç»†çš„æ–‡å­—ï¼Œå¸®åŠ©å…¶ä»–ç”¨æˆ·è§£å†³ç”Ÿæ´»ä¸­çš„å„ç§é—®é¢˜ã€‚

è¿™ç§åˆ†äº«ç²¾ç¥è®©å°çº¢ä¹¦æˆä¸ºäº†ä¸€ä¸ªå……æ»¡æ­£èƒ½é‡çš„ç¤¾åŒºã€‚

## é•¿æ–‡æ’ç‰ˆæŒ‘æˆ˜

å¯¹äºé•¿æ–‡åˆ›ä½œè€…æ¥è¯´ï¼Œå¦‚ä½•å°†å¤§æ®µæ–‡å­—ä¼˜é›…åœ°å‘ˆç°åœ¨å°çº¢ä¹¦ä¸Šæ˜¯ä¸€ä¸ª~~æŒ‘æˆ˜~~**æœºä¼š**ã€‚

### è§£å†³æ–¹æ¡ˆ

è¿™ä¸ªå·¥å…·å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œè®¾è®¡çš„ã€‚å®ƒä¼šè‡ªåŠ¨åˆ†é¡µç¡®ä¿å†…å®¹ä¸ä¼šè¦†ç›–æ°´å°å’Œé¡µç ã€‚ä½ å¯ä»¥ç”¨å›è½¦æ¥æ§åˆ¶æ®µè½é—´è·ï¼Œåˆ›é€ ä½ æƒ³è¦çš„è§†è§‰æ•ˆæœã€‚

## ä½¿ç”¨æŠ€å·§

â€¢ ä½¿ç”¨æ ‡é¢˜æŒ‰é’®å¿«é€Ÿæ·»åŠ æ ‡é¢˜æ ¼å¼
â€¢ æ”¯æŒ **åŠ ç²—**ã€*æ–œä½“*ã€__ä¸‹åˆ’çº¿__ã€~~åˆ é™¤çº¿~~
â€¢ æ”¯æŒé¢œè‰²æ ‡è®°ï¼š[color:#ff4757]çº¢è‰²æ–‡å­—[/color]
â€¢ è‡ªåŠ¨åˆ†é¡µï¼Œæ™ºèƒ½æ’ç‰ˆ`;
            }

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            const textarea = document.getElementById('inputText');
            if (textarea) {
                textarea.addEventListener('input', updatePreview);
            }

            const fontSelect = document.getElementById('fontFamily');
            if (fontSelect) {
                fontSelect.addEventListener('change', updateFontDisplay);
            }

            const fontSizeInput = document.getElementById('fontSize');
            if (fontSizeInput) {
                fontSizeInput.addEventListener('change', regenerateIfNeeded);
            }

            const lineHeightInput = document.getElementById('lineHeight');
            if (lineHeightInput) {
                lineHeightInput.addEventListener('change', regenerateIfNeeded);
            }

            // å»¶è¿Ÿè‡ªåŠ¨ç”Ÿæˆé¢„è§ˆï¼Œç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²åŠ è½½
            setTimeout(() => {
                try {
                    generatePages();
                } catch (e) {
                    console.error('è‡ªåŠ¨ç”Ÿæˆé¢„è§ˆå¤±è´¥:', e);
                }
            }, 500);
        });
    </script>
</body>

</html>